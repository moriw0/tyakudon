# プロダクト要求定義書 (Product Requirements Document)

## プロダクト概要

### 名称
**ちゃくどん (Tyakudon)** - ラーメン店の待ち時間測定・共有Webアプリケーション

### プロダクトコンセプト
- **リアルタイム待ち時間可視化**: 並び始めから着丼までの時間を記録・共有
- **コミュニティベースの情報**: ユーザー同士で行列状況をシェア
- **ソーシャル機能**: お気に入り・いいね・応援メッセージで楽しく待つ

### プロダクトビジョン
人気ラーメン店での待ち時間を可視化し、ラーメン愛好家のコミュニティを形成する。待ち時間の不確実性を減らし、並ぶ価値があるかの判断材料を提供することで、より充実したラーメン体験を実現する。

### 目的
- **待ち時間の透明性向上**: 行列に並ぶ前に待ち時間の目安を知る
- **混雑状況の可視化**: リアルタイムの行列状況を共有
- **ラーメン愛好家のコミュニティ形成**: 訪問記録を通じて繋がる
- **店舗選びの意思決定支援**: データに基づいた店舗選択

## ターゲットユーザー

### プライマリーペルソナ: 佐藤健太（28歳、会社員）
- **基本属性**: 都内在住、IT企業勤務、ラーメンが大好きで週末は必ずラーメン店巡り
- **技術リテラシー**: スマートフォンを日常的に使用、SNS（Instagram、X）で情報収集
- **現在の課題**:
  - 人気店の待ち時間が読めず、予定が立てにくい
  - 並んでから「これは長すぎる」と後悔することがある
  - 訪れた店の記録を残したいが手段がない（Googleマップのレビューは面倒）
  - 混雑する時間帯がわからず、ピーク時に行ってしまう
- **期待する解決策**:
  - 訪問前に待ち時間の目安を知りたい（平均30分なら並ぶ、2時間なら諦める）
  - リアルタイムの行列状況を確認したい（今何人待ち？）
  - 訪問記録を簡単に残してコレクションしたい
  - 他のラーメン好きのレコードを見て楽しみたい
- **1日の典型的なワークフロー**:
  1. **土曜朝10時**: ちゃくどんで今日行く店を検索、過去の待ち時間データを確認
  2. **11時到着**: 並び始めたら「計測開始」をタップ
  3. **待ち時間中**: 行列状況を更新（「外待ち15人」）、他の人のレコードを見て期待を高める
  4. **11時45分着丼**: 記録完了、コメントを追加（「豚骨の香りが最高！」）、写真をアップロード
  5. **夕方**: いいねがついていることを確認、応援メッセージに励まされる

### セカンダリーペルソナ: 山田美咲（35歳、フリーランス）
- **基本属性**: フリーランスデザイナー、食べ歩きが趣味、SNSで食レポを発信
- **技術リテラシー**: InstagramやX（旧Twitter）で積極的に情報発信、写真撮影が得意
- **現在の課題**:
  - 話題の新店に行きたいが待ち時間が心配（時間が読めない）
  - 混雑を避けたいが、どの時間帯が空いているか情報が少ない
  - 訪問記録をSNSと別で管理したい（ラーメン専用の記録）
  - 他のラーメン好きと繋がりたい
- **期待する解決策**:
  - 混雑する時間帯を避けられる（平日昼や夕方のデータがあると助かる）
  - 訪問記録を簡単に残せる（写真とコメント）
  - いいね機能でコミュニティと繋がれる
  - お気に入りの店をリスト化できる

## 成功指標(KPI)

### プライマリーKPI
- **月間アクティブユーザー(MAU)**: 500人（リリース後3ヶ月）
  - 測定方法: Googleアナリティクスによるユニークユーザー数
- **1日あたりの新規レコード投稿数**: 平均20件
  - 測定方法: データベースの`records`テーブルの`created_at`から集計
- **レコード完了率**: 70%以上（`started_at`から`ended_at`が記録される割合）
  - 測定方法: `ended_at IS NOT NULL`のレコード数 / 全レコード数
  - 重要性: ユーザーが最後まで計測を完了しているかの指標

### セカンダリーKPI
- **お気に入り登録数**: 1ユーザーあたり平均3店舗
  - 測定方法: `favorites`テーブルの集計
- **いいね平均数**: 1レコードあたり平均2いいね
  - 測定方法: `likes`テーブルの集計
- **リピート訪問率**: 1週間後に50%のユーザーが再訪問
  - 測定方法: Googleアナリティクスによるリターニングユーザー率
- **店舗カバレッジ**: 登録ラーメン店舗数100店舗（リリース後3ヶ月）
  - 測定方法: `ramen_shops`テーブルのレコード数

## 機能要件

### コア機能(MVP) - P0 ✅ 実装済み

#### 1. ユーザー認証

**ユーザーストーリー**:
ラーメン愛好家として、安全にアカウントを作成し、自分の記録を管理したい

**受け入れ条件**:
- [x] メールアドレス + パスワードで新規登録できる
- [x] メール確認（activation）機能がある
- [x] Google OAuth2でログインできる
- [x] パスワードリセット機能がある
- [x] ログイン状態を維持できる

**優先度**: P0（必須）

**実装状況**:
- `User`モデル（`has_secure_password`、OAuth対応）
- `SessionsController`、`UsersController`、`OmniauthUsersController`
- メール認証（`activated`フラグ）、パスワードリセット機能

#### 2. ラーメン店舗管理

**ユーザーストーリー**:
ラーメン愛好家として、行きたい店舗を検索・閲覧したい

**受け入れ条件**:
- [x] 店舗一覧が表示される
- [x] 店舗詳細ページで店舗情報（名前、住所、地図）が見られる
- [x] 店舗名・住所で検索できる
- [x] Geocoderで緯度経度が自動取得される
- [x] 店舗登録リクエスト機能がある（`ShopRegisterRequest`）

**優先度**: P0（必須）

**実装状況**:
- `RamenShop`モデル（Geocoder統合、`name`と`address`のユニーク制約）
- `RamenShopsController`
- `ShopRegisterRequest`モデル（pending/approved/rejected ステータス）

#### 3. 待ち時間測定・記録

**ユーザーストーリー**:
ラーメン愛好家として、並び始めから着丼までの時間を記録したい

**受け入れ条件**:
- [x] 計測開始ボタンで`started_at`を記録
- [x] 計測終了ボタンで`ended_at`を記録し、`wait_time`を自動計算
- [x] コメントを追加できる
- [x] 写真をアップロードできる（Active Storage）
- [x] 計測中の記録は編集・削除可能
- [x] 1日経過した計測中レコードは自動終了される（`AutoRetireRecordJob`）

**優先度**: P0（必須）

**実装状況**:
- `Record`モデル（`user_id`, `ramen_shop_id`, `started_at`, `ended_at`, `wait_time`, `comment`, `is_retired`, `auto_retired`）
- `RecordsController`
- `AutoRetireRecordJob`（GoodJob）
- Active Storage統合（画像アップロード）

#### 4. レコード閲覧・検索

**ユーザーストーリー**:
ラーメン愛好家として、他のユーザーの待ち時間記録を見て、店選びの参考にしたい

**受け入れ条件**:
- [x] 店舗ごとのレコード一覧が表示される
- [x] ユーザーごとのレコード一覧が表示される
- [x] 待ち時間の統計情報（平均、最短、最長）が見られる
- [x] 日時・待ち時間でソートできる
- [x] ページネーション対応

**優先度**: P0（必須）

**実装状況**:
- `RecordsController`（index、show）
- Kaminariによるページネーション

#### 5. リアルタイム行列状況共有

**ユーザーストーリー**:
ラーメン愛好家として、今この瞬間の行列の長さを共有したい

**受け入れ条件**:
- [x] 行列人数を投稿できる
- [x] 行列タイプ（店内待ち、外待ち、食券購入待ち）を選択できる
- [x] コメントを追加できる
- [x] 最新の行列状況が表示される

**優先度**: P0（必須）

**実装状況**:
- `LineStatus`モデル（`record_id`, `line_number`, `line_type`, `comment`）
- `LineStatusesController`
- `line_type` enum（waiting_inside: 0, waiting_outside: 1, waiting_ticket: 2）

#### 6. お気に入り・いいね機能

**ユーザーストーリー**:
ラーメン愛好家として、よく行く店をお気に入り登録し、良い記録にいいねしたい

**受け入れ条件**:
- [x] 店舗をお気に入り登録/解除できる
- [x] お気に入り一覧が表示される
- [x] レコードにいいね/解除できる
- [x] いいね数が表示される

**優先度**: P0（必須）

**実装状況**:
- `Favorite`モデル（`user_id`, `ramen_shop_id`、ユニーク制約）
- `Like`モデル（`user_id`, `record_id`、ユニーク制約）
- `FavoritesController`, `LikesController`

#### 7. 応援メッセージ生成（AI統合）

**ユーザーストーリー**:
ラーメン愛好家として、長時間待っている時に応援メッセージで励まされたい

**受け入れ条件**:
- [x] OpenAI APIで自動生成された応援メッセージが届く
- [x] バックグラウンドジョブで非同期実行される
- [x] 待ち時間が一定以上の記録に送信される

**優先度**: P0（必須）

**実装状況**:
- `CheerMessage`モデル（`record_id`, `content`, `role`）
- `SpeakCheerMessageJob`（GoodJob + OpenAI API）
- `CheerMessagesController`

#### 8. FAQ管理

**ユーザーストーリー**:
ユーザーとして、よくある質問を簡単に確認したい

**受け入れ条件**:
- [x] FAQページが表示される
- [x] 質問と回答が見やすく整理されている

**優先度**: P0（必須）

**実装状況**:
- `FAQ`モデル（`question`, `answer`）
- `FaqsController`

### 重要機能(Post-MVP) - P1

#### 9. 店舗レビュー・評価機能

**ユーザーストーリー**:
ラーメン愛好家として、店舗に対する総合的な評価やレビューを投稿したい

**受け入れ条件**:
- [ ] 店舗に対して5段階評価ができる
- [ ] レビューテキストを投稿できる
- [ ] 店舗詳細ページに平均評価が表示される
- [ ] レビュー一覧が表示される

**優先度**: P1（重要）

#### 10. ユーザーフォロー機能

**ユーザーストーリー**:
ラーメン愛好家として、気になるユーザーをフォローして、その人の記録を追いたい

**受け入れ条件**:
- [ ] ユーザーをフォロー/アンフォローできる
- [ ] フォロー中のユーザーの記録が一覧で見られる
- [ ] フォロワー数・フォロー数が表示される

**優先度**: P1（重要）

#### 11. 通知機能

**ユーザーストーリー**:
ラーメン愛好家として、お気に入り店舗の混雑状況が変化したら通知してほしい

**受け入れ条件**:
- [ ] お気に入り店舗に新しい行列状況が投稿されたら通知
- [ ] 自分のレコードにいいねがついたら通知
- [ ] フォロワーが増えたら通知

**優先度**: P1（重要）

#### 12. 統計ダッシュボード

**ユーザーストーリー**:
ラーメン愛好家として、自分の訪問履歴や統計を見たい

**受け入れ条件**:
- [ ] 訪問店舗数、総待ち時間、平均待ち時間が表示される
- [ ] 月別の訪問回数グラフが見られる
- [ ] 最も訪問した店舗ランキングが表示される

**優先度**: P1（重要）

### 将来的な機能(Post-MVP) - P2

#### 13. ラーメン店とのAPI連携

店舗側がリアルタイムで待ち時間情報を提供できる機能

**優先度**: P2（できれば）

#### 14. モバイルアプリ（iOS/Android）

ネイティブアプリによる通知機能とオフライン対応

**優先度**: P2（できれば）

#### 15. メニュー情報・写真投稿

各店舗のメニュー情報や料理写真を投稿・閲覧できる機能

**優先度**: P2（できれば）

#### 16. 店舗情報の自動スクレイピング

Webスクレイピングで店舗情報を自動取得・更新する機能

**優先度**: P2（できれば）

**実装状況**:
- `DocumentFetcher`, `ShopInfoExtractor`, `ShopInfoInserter`サービスが存在
- `GoogleSpreadSheet`サービスでワークフロー管理
- 現在は手動実行（今後自動化を検討）

## 非機能要件

### パフォーマンス
- **ページロード時間**: 2秒以内（記録一覧ページ、100件表示時）
- **レコード投稿レスポンス**: 1秒以内
- **同時接続ユーザー**: 100人対応（Fly.io Free tier想定）
- **データベースクエリ**: N+1問題の回避（Bullet gemで検出）

### ユーザビリティ
- **スマートフォン最適化**: レスポンシブデザイン（Bootstrap使用）
- **直感的なUI**: 計測開始/終了が1タップで可能
- **高速ページ遷移**: Hotwire (Turbo) でSPA風の体験
- **エラーメッセージ**: 日本語でわかりやすく表示

### 信頼性
- **データ損失ゼロ**: PostgreSQLトランザクション保証
- **自動退職機能**: 1日経過した計測中記録を自動終了（`AutoRetireRecordJob`）
- **バックアップ**: Fly.ioの自動バックアップ機能

### セキュリティ
- **Rails credentials**: 秘密情報の暗号化管理（Google OAuth、OpenAI API key）
- **SQL injection対策**: ActiveRecord ORM使用
- **CSRF対策**: Rails標準のCSRFトークン
- **パスワードハッシュ化**: bcryptによるハッシュ化（`has_secure_password`）
- **XSS対策**: Railsの自動エスケープ

### 互換性
- **ブラウザ**: Chrome、Safari、Firefox最新版
- **デバイス**: スマートフォン（iOS/Android）、PC
- **言語**: 日本語（将来的に多言語対応を検討）

## 技術スタック

| レイヤー | 技術 | バージョン |
|---------|-----|----------|
| 言語 | Ruby | 3.2.2 |
| フレームワーク | Rails | 7.0 |
| データベース | PostgreSQL | 14 |
| フロントエンド | Bootstrap + Hotwire | - |
| バックグラウンドジョブ | GoodJob | - |
| 認証 | bcrypt + Google OAuth2 | - |
| 位置情報 | Geocoder | - |
| AI統合 | OpenAI API | - |
| ファイルストレージ | Active Storage (S3 in production) | - |
| ホスティング | Fly.io | - |
| CI/CD | GitHub Actions | - |

## スコープ

### 対象地域
日本全国（現在は店舗登録リクエストで拡大中）

### 対象デバイス
PC・スマートフォンブラウザ

### 言語
日本語（将来的に多言語対応を検討）

## スコープ外

明示的にスコープ外とする項目:

- **ネイティブアプリ**: Webアプリケーションのみでスタート（モバイルアプリは将来検討）
- **予約機能**: 店舗予約システムは提供しない
- **決済機能**: 有料機能は当面なし（完全無料）
- **店舗管理者向けダッシュボード**: ユーザー向け機能のみ
- **リアルタイムチャット**: ユーザー間のチャット機能は対象外
- **多言語対応**: MVP段階では日本語のみ（将来的に英語・中国語対応を検討）
- **広告機能**: 広告表示・収益化は対象外
